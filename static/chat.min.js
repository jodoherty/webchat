(function(){function h(a,b,d){var c=new XMLHttpRequest;c.open("POST",a,!0);c.setRequestHeader("Content-Type","application/json");c.onload=d;c.send(JSON.stringify(b))}function l(a){h("/chat/poll-messages",a,function(){t(JSON.parse(this.responseText));setTimeout(function(){l({})},u)})}function m(){h("/chat/poll-users",null,function(){var a=JSON.parse(this.responseText),b=document.createElement("ul"),d=n,c,e,f;b.className="chat-userlist";a.sort();e=a.length;for(c=0;c<e;c+=1)f=document.createElement("li"),
f.appendChild(document.createTextNode(a[c])),b.appendChild(f);if(void 0!==d){for(;d.lastChild;)d.removeChild(d.lastChild);d.appendChild(b)}setTimeout(m,v)})}function p(a){var b=document.createElement("div"),d=document.createElement("div"),c=document.createElement("div"),e=q,f;void 0===a&&(a={});f=a.username||"System";a=a.body||"";c.appendChild(document.createTextNode(f));d.appendChild(document.createTextNode(a));b.className="chat-message-window";c.className="chat-message-window-username-label";d.className=
"chat-message-window-body";b.appendChild(c);b.appendChild(d);void 0!==e&&(g>w&&(e.removeChild(e.firstChild),g-=1),e.appendChild(b),g+=1,b.scrollIntoView());return b}function t(a){var b,d;d=a.length;for(b=0;b<d;b+=1)p(a[b])}function r(a,b){h("/chat/say",{message:a},function(){res=JSON.parse(this.responseText);res.error?p({username:"*** System Message ***",body:res.message}):(b(),s=Date.now())})}function x(a,b){var d=s+y-Date.now();0<d?(document.getElementById("chat-DELAY-warning").style.display="block",
k=!0,setTimeout(function(){document.getElementById("chat-DELAY-warning").style.display="none";k=!1;r(a,b)},d)):r(a,b)}var y=500,w=200,v=1E3,u=300,g=0,s=0,k=!1,n,q;window.addEventListener("load",function(){var a=0,b=[],d,c=document.getElementById("chat-message-input");n=document.getElementById("chat-userlist-container");q=document.getElementById("chat-message-container");c.addEventListener("keydown",function(e){var f=e.key||e.keyCode;13===f?(!1===k&&c.value.trim()&&x(c.value,function(){b.push(c.value);
a=b.length;d="";c.value=""}),e.preventDefault()):38===f||80===f&&e.ctrlKey?(0<a&&(a===b.length&&(d=c.value||""),a-=1,c.value=b[a]),e.preventDefault()):40===f||78===f&&e.ctrlKey?(0<b.length&&a<b.length&&(a+=1,c.value=a===b.length?d:b[a]),e.preventDefault()):9===f&&e.preventDefault()});c.focus();m();l({all:!0})})})();
